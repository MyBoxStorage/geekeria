// Prisma Schema - BRAVOS BRASIL E-commerce
// Database: PostgreSQL

generator client {
  provider      = "prisma-client-js"
  output        = "../server/node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  image       String?
  category    String
  sizes       String[] // Array de tamanhos disponíveis
  colors      String[] // Array de cores disponíveis
  stock       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Campos adicionais já existentes no DB (alinhamento Prisma ↔ Supabase)
  slug          String?
  gender        String  @default("unissex")
  originalPrice Float?  @map("original_price")
  images        Json?
  colorStock    Json?   @map("color_stock")
  badge         String?
  isNew         Boolean @default(false) @map("is_new")
  isBestseller  Boolean @default(false) @map("is_bestseller")
  rating        Float   @default(4.8)
  reviews       Int     @default(0)

  // SEO fields
  metaTitle       String?   @map("meta_title")
  metaDescription String?   @map("meta_description")
  seoTags         String[]  @map("seo_tags")
  isPublished     Boolean   @default(true) @map("is_published")

  orderItems OrderItem[]

  @@map("products")
}

model Order {
  id                String      @id @default(cuid())
  total             Float
  subtotal          Float? // Subtotal antes de frete e descontos
  discountTotal     Float?      @map("discount_total") // Desconto total aplicado
  status            OrderStatus @default(PENDING)
  mpPaymentId       String?     @map("mp_payment_id") // ID do pagamento no Mercado Pago
  mpPreferenceId    String?     @map("mp_preference_id") // ID da preferência de pagamento no Mercado Pago
  mpStatus          String?     @map("mp_status") // Status do pagamento no MP
  payerName         String?     @map("payer_name")
  payerEmail        String      @map("payer_email")
  payerCpf          String?     @map("payer_cpf")
  payerPhone        String?     @map("payer_phone")
  paymentMethod     String?     @map("payment_method") // "pix" ou "bolbradesco"
  pixQrCode         String?     @map("pix_qr_code") // QR Code do PIX
  pixCopyPaste      String?     @map("pix_copy_paste") // Código copia e cola do PIX
  boletoUrl         String?     @map("boleto_url") // URL do boleto
  boletoBarcode     String?     @map("boleto_barcode") // Código de barras do boleto
  externalReference String      @unique @map("external_reference") // Referência externa única

  // Endereço de entrega
  shippingCep        String? @map("shipping_cep") // CEP
  shippingAddress1   String? @map("shipping_address1") // Rua/avenida
  shippingNumber     String? @map("shipping_number") // Número (string pq pode ter "S/N")
  shippingDistrict   String? @map("shipping_district") // Bairro
  shippingCity       String? @map("shipping_city") // Cidade
  shippingState      String? @map("shipping_state") // UF
  shippingComplement String? @map("shipping_complement") // Complemento

  // Informações de frete
  shippingCost     Float   @default(0) @map("shipping_cost") // Custo do frete
  shippingService  String? @map("shipping_service") // Nome do serviço/transportadora
  shippingDeadline Int?    @map("shipping_deadline") // Prazo em dias

  // Integração Montink
  montinkOrderId String? @map("montink_order_id") // ID do pedido no Montink
  montinkStatus  String? @map("montink_status") // Status do pedido no Montink

  // Telemetria / anti-fraude (MVP, não bloqueia compra)
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  riskScore   Int?     @default(0) @map("risk_score")
  riskFlag    Boolean? @default(false) @map("risk_flag")
  riskReasons String?  @map("risk_reasons") // motivos curtos separados por vírgula (sem PII)

  // Cupom
  couponCode           String? @map("coupon_code")
  couponDiscountAmount Float?  @map("coupon_discount_amount")

  // Auth + créditos (estampas)
  buyerId        String? @map("buyer_id")
  buyer          User?   @relation("UserPurchases", fields: [buyerId], references: [id])
  generationId   String? @map("generation_id")
  creditsGranted Boolean @default(false) @map("credits_granted")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items       OrderItem[]
  adminEvents AdminEvent[]

  @@index([mpPaymentId])
  @@index([status, createdAt])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Int
  unitPrice Float    @map("unit_price")
  size      String?
  color     String?
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  PAID
  READY_FOR_MONTINK // Pedido pago, pronto para envio à Montink (quando POST estiver disponível)
  SENT_TO_MONTINK // Pedido enviado à Montink com sucesso
  FAILED_MONTINK // Falha ao enviar pedido à Montink
  CANCELED
  FAILED
  REFUNDED
}

model WebhookEvent {
  id           String    @id @default(cuid())
  provider     String // Ex: "mercadopago"
  eventId      String    @map("event_id") // ID do evento/notificação ou payment id
  eventType    String?   @map("event_type") // payment, merchant_order, etc.
  receivedAt   DateTime  @default(now()) @map("received_at")
  processedAt  DateTime? @map("processed_at")
  payload      Json? // Armazena o payload bruto se útil
  status       String? // processed / ignored / failed
  errorMessage String?   @map("error_message")

  @@unique([provider, eventId])
  @@map("webhook_events")
}

model AdminEvent {
  id                String   @id @default(cuid())
  action            String
  orderId           String   @map("order_id")
  externalReference String   @map("external_reference")
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("admin_events")
}

// ==================== AUTH + STAMP GENERATION ====================

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String  @map("password_hash")
  name         String?
  phone        String?

  // Verificação de e-mail
  emailVerified   Boolean   @default(true) @map("email_verified")
  verifyToken    String?   @map("verify_token")
  verifyTokenExp DateTime? @map("verify_token_exp")

  // Sistema de créditos
  credits          Int @default(5)
  totalGenerations Int @default(0) @map("total_generations")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  generations     Generation[]
  creditLogs      CreditLog[]
  purchasedOrders Order[]       @relation("UserPurchases")
  couponUsages    CouponUsage[]

  @@index([email])
  @@map("users")
}

model Generation {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  prompt      String  @db.Text
  imageUrl    String? @map("image_url") @db.Text
  uploadedImg String? @map("uploaded_img") @db.Text

  status   GenerationStatus @default(PENDING)
  errorMsg String?          @map("error_msg") @db.Text

  usedInOrderId String? @map("used_in_order_id")

  expiresAt DateTime? @map("expires_at")
  isExpired Boolean   @default(false) @map("is_expired")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([status])
  @@index([expiresAt, isExpired])
  @@map("generations")
}

enum GenerationStatus {
  PENDING
  COMPLETED
  FAILED
}

model CreditLog {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount    Int // +5 ou -1
  reason    CreditReason
  orderId   String?      @map("order_id")
  adminNote String?      @map("admin_note") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("credit_logs")
}

enum CreditReason {
  SIGNUP // Cadastro inicial (+5)
  GENERATION // Consumo ao gerar (-1)
  PURCHASE // Compra aprovada (+5)
  ADMIN_GRANT // Admin liberou manualmente
  ADMIN_REVOKE // Admin removeu
}

model PromptTemplate {
  id        String   @id @default(cuid())
  name      String
  content   String   @db.Text
  isActive  Boolean  @default(false) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("prompt_templates")
}

enum CouponType {
  PERCENTAGE
  FIXED
}

model Coupon {
  id        String     @id @default(cuid())
  code      String     @unique
  type      CouponType @default(PERCENTAGE)
  value     Float // Percentual (ex: 10 = 10%) ou valor fixo (ex: 5.00)
  maxUses   Int?       @map("max_uses") // Null = ilimitado
  usedCount Int        @default(0) @map("used_count")
  isActive  Boolean    @default(true) @map("is_active")
  expiresAt DateTime?  @map("expires_at")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  usages CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model CouponUsage {
  id             String   @id @default(cuid())
  couponId       String   @map("coupon_id")
  userId         String   @map("user_id")
  orderId        String?  @map("order_id")
  discountAmount Float    @map("discount_amount")
  createdAt      DateTime @default(now()) @map("created_at")

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@map("coupon_usages")
}
