name: Deploy Backend to Fly.io

# Required secrets: DATABASE_URL, FLY_API_TOKEN, ADMIN_TOKEN. Optional: MONITOR_API_URL (smoke fallback: bravosbackend.fly.dev)
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'prisma/**'
      - '.github/workflows/deploy-backend-fly.yml'
      - 'package.json'
      - 'vite.config.*'
      - 'tsconfig*.json'
      - 'src/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log deployed commit
        run: |
          echo "Deploying commit SHA: $(git rev-parse HEAD)"
          echo "Commit message: $(git log -1 --pretty=%B)"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build frontend
        run: npm ci && npm run build

      - name: Build backend
        run: |
          cd server && npm ci
          npx prisma@5.22.0 generate --schema=../prisma/schema.prisma
          npm run build

      - name: Validate DATABASE_URL
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::error::DATABASE_URL secret is not configured. Add it in GitHub Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "DATABASE_URL is set"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Prisma migrate deploy
        run: npx prisma migrate deploy --schema=./prisma/schema.prisma
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Flyctl version
        run: flyctl version

      - name: Debug build context (no secrets)
        run: |
          pwd
          ls -la
          ls -la server
          ls -la server/routes/internal
          test -f server/routes/internal/cancel-abandoned.ts || (echo "::error::cancel-abandoned.ts missing" && exit 1)
          test -f server/Dockerfile
          test -f server/fly.toml

      - name: Deploy to Fly.io
        run: |
          set -x
          flyctl deploy . \
            --remote-only \
            --config server/fly.toml \
            --dockerfile server/Dockerfile \
            --build-arg BUILD_SHA=${{ github.sha }} \
            -a bravosbackend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify runtime SHA
        env:
          BACKEND_URL: ${{ secrets.MONITOR_API_URL }}
        run: |
          URL="${BACKEND_URL:-https://bravosbackend.fly.dev}"
          EXPECTED_SHA="${{ github.sha }}"
          echo "Expected buildSha: $EXPECTED_SHA"
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            resp=$(curl -fsS "$URL/health" 2>/dev/null || true)
            echo "Response: $resp"
            if echo "$resp" | grep -q '"buildSha"'; then
              if echo "$resp" | grep -q "$EXPECTED_SHA"; then
                echo "buildSha matches $EXPECTED_SHA"
                exit 0
              fi
              echo "::error::buildSha in response does not match expected. Expected: $EXPECTED_SHA. Body: $resp"
              exit 1
            fi
            echo "buildSha key missing from response, retrying in 5s..."
            sleep 5
          done
          echo "::error::buildSha not found in /health after 3 attempts. Expected: $EXPECTED_SHA. Last body: $resp"
          exit 1

      - name: Smoke — GET /health/ready (DB readiness)
        env:
          BACKEND_URL: ${{ secrets.MONITOR_API_URL }}
        run: |
          URL="${BACKEND_URL:-https://bravosbackend.fly.dev}"
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            code=$(curl -s -o /tmp/health-ready.json -w "%{http_code}" "$URL/health/ready")
            echo "Status: $code"
            if [ "$code" = "200" ]; then
              cat /tmp/health-ready.json
              echo ""
              echo "health/ready: OK"
              exit 0
            fi
            echo "health/ready returned $code, retrying in 5s..."
            sleep 5
          done
          echo "::error::health/ready not 200 after 3 attempts (last: $code)"
          cat /tmp/health-ready.json 2>/dev/null || true
          exit 1

      - name: Smoke — GET /api/internal/monitor
        env:
          BACKEND_URL: ${{ secrets.MONITOR_API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          URL="${BACKEND_URL:-https://bravosbackend.fly.dev}"
          node scripts/monitor-check.js "$URL" "$ADMIN_TOKEN"

      - name: Smoke — POST /api/internal/cancel-abandoned (dryRun)
        env:
          BACKEND_URL: ${{ secrets.MONITOR_API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          URL="${BACKEND_URL:-https://bravosbackend.fly.dev}"
          code=$(curl -s -o /tmp/cancel-abandoned.json -w "%{http_code}" \
            -X POST "$URL/api/internal/cancel-abandoned" \
            -H "x-admin-token: $ADMIN_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"olderThanMinutes":60,"limit":10,"dryRun":true}')
          echo "cancel-abandoned status: $code"
          if [ "$code" = "404" ]; then
            echo "::error::cancel-abandoned returned 404 - endpoint not deployed"
            exit 1
          fi
          if [ "$code" != "200" ] && [ "$code" != "401" ]; then
            echo "::error::cancel-abandoned returned $code"
            head -c 200 /tmp/cancel-abandoned.json
            exit 1
          fi
          echo "cancel-abandoned smoke: OK (status $code)"
